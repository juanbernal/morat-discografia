
name: Actualizar Reflexiones Blogger

on:
  schedule:
    - cron: '0 */12 * * *' 
  workflow_dispatch: 

jobs:
  update-blog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and Process Blogger Data
        run: |
          BLOG_ID="5031959192789589903"
          API_KEY="${{ secrets.BLOGGER_API_KEY }}"
          
          if [ -z "$API_KEY" ]; then
            echo "ERROR: BLOGGER_API_KEY no configurado."
            exit 1
          fi

          mkdir -p public
          URL="https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts?key=${API_KEY}&maxResults=20"
          
          RESPONSE=$(curl -s -w "%{http_code}" "$URL" -o raw.json)
          
          if [ "$RESPONSE" != "200" ]; then
            echo "Error API Google: $RESPONSE"
            exit 1
          fi

          # Script robusto para extraer imágenes:
          # 1. Busca en el campo 'images' oficial.
          # 2. Si no hay, busca la primera URL en el contenido que termine en extensiones de imagen.
          # 3. Limpia las URLs para alta resolución.
          cat raw.json | jq '[.items[] | {
            id: .id,
            title: .title,
            url: .url,
            published: .published,
            thumbnail: (
              if .images then .images[0].url 
              else (
                .content | [match("src=\"([^\"]+)\""; "g")] | .[0].captures[0].string
              ) // "https://images.unsplash.com/photo-1499750310107-5fef28a66643?auto=format&fit=crop&q=80&w=800"
              end | if type == "string" and (contains("blogger.googleusercontent.com") or contains("bp.blogspot.com") or contains("googleusercontent.com")) then 
                sub("/s[0-9]+(-c)?/"; "/s1600/") | sub("=s[0-9]+(-c)?"; "=s1600")
              else 
                .
              end
            ),
            summary: (.content | sub("<[^>]*>"; ""; "g") | sub("&nbsp;"; " "; "g") | .[0:5000])
          }]' > public/blog.json

      - name: Commit and Push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add public/blog.json
          git diff --staged --quiet || (git commit -m "chore: optimizar lectura directa y miniaturas de blogger" && git push)
