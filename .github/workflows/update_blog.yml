name: Actualizar Reflexiones Blogger

on:
  schedule:
    - cron: '0 */12 * * *' 
  workflow_dispatch: 

jobs:
  update-blog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and Process Blogger Data
        run: |
          BLOG_ID="5031959192789589903"
          API_KEY="${{ secrets.BLOGGER_API_KEY }}"
          
          if [ -z "$API_KEY" ]; then
            echo "ERROR: BLOGGER_API_KEY no configurado."
            exit 1
          fi

          mkdir -p public
          URL="https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts?key=${API_KEY}&maxResults=20"
          
          RESPONSE=$(curl -s -w "%{http_code}" "$URL" -o raw.json)
          
          if [ "$RESPONSE" != "200" ]; then
            echo "Error API Google: $RESPONSE"
            exit 1
          fi

          # Script mejorado para extraer la primera imagen y limpiar el contenido HTML
          cat raw.json | jq '[.items[]? | {
            id: .id,
            title: (.title | sub("<[^>]*>"; ""; "g")),
            url: .url,
            published: .published,
            thumbnail: (
              if .images and (.images | length > 0) then .images[0].url 
              else (
                [.content | scan("src=\\\"([^\\\"]+)\\\"")] | .[0][0]
              ) // "https://images.unsplash.com/photo-1499750310107-5fef28a66643?auto=format&fit=crop&q=80&w=800"
              end | if type == "string" and (test("blogger.googleusercontent.com|bp.blogspot.com|googleusercontent.com")) then 
                sub("/s[0-9]+(-c)?/"; "/s1600/") | sub("=s[0-9]+(-c)?"; "=s1600")
              else 
                .
              end
            ),
            summary: (.content | sub("<script[^>]*>[\\s\\S]*?</script>"; ""; "g") | sub("<style[^>]*>[\\s\\S]*?</style>"; ""; "g") | sub("<[^>]*>"; ""; "g") | sub("&nbsp;"; " "; "g") | sub("&quot;"; "\""; "g") | sub("&apos;"; "'\''"; "g") | sub("&amp;"; "&"; "g") | .[0:40000])
          }]' > public/blog.json

      - name: Commit and Push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add public/blog.json
          git diff --staged --quiet || (git commit -m "chore: update blog reflections" && git push)
