
name: Actualizar Reflexiones Blogger

on:
  schedule:
    - cron: '0 */12 * * *' 
  workflow_dispatch: 

jobs:
  update-blog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and Process Blogger Data
        run: |
          BLOG_ID="5031959192789589903"
          API_KEY="${{ secrets.BLOGGER_API_KEY }}"
          
          if [ -z "$API_KEY" ]; then
            echo "ERROR: BLOGGER_API_KEY no configurado."
            exit 1
          fi

          mkdir -p public
          URL="https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts?key=${API_KEY}&maxResults=15"
          
          RESPONSE=$(curl -s -w "%{http_code}" "$URL" -o raw.json)
          
          if [ "$RESPONSE" != "200" ]; then
            echo "Error API Google: $RESPONSE"
            exit 1
          fi

          # Script mejorado para extraer imagen del contenido HTML si 'images' está vacío.
          # 1. Busca en el array 'images' de Blogger.
          # 2. Si no hay, usa regex para buscar el primer 'src' de una etiqueta 'img' en el contenido.
          # 3. Transforma la URL de Blogger (/s72-c/, etc) a /s1600/ para máxima calidad.
          cat raw.json | jq '[.items[] | {
            id: .id,
            title: .title,
            url: .url,
            published: .published,
            thumbnail: (
              if .images then .images[0].url 
              else (.content | capture("src=\"(?<url>[^\"]+)\"") | .url) // "https://images.unsplash.com/photo-1499750310107-5fef28a66643?auto=format&fit=crop&q=80&w=800"
              end | sub("/s[0-9]+(-c)?/"; "/s1600/")
            ),
            summary: (.content | sub("<[^>]*>"; ""; "g") | .[0:160] + "...")
          }]' > public/blog.json

      - name: Commit and Push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add public/blog.json
          git diff --staged --quiet || (git commit -m "chore: corregir miniaturas de reflexiones" && git push)
